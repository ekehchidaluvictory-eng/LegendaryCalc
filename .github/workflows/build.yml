name: Build Android APK
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  BUILDOZER_VERSION: '1.5.0'
  CYTHON_VERSION: '3.0.11'

jobs:
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify buildozer.spec exists
        run: |
          if [ ! -f "buildozer.spec" ]; then
            echo "Error: buildozer.spec not found!"
            exit 1
          fi
          echo "✓ buildozer.spec found"

      - name: Validate buildozer.spec syntax
        run: |
          if grep -q "title = " buildozer.spec && grep -q "package.name = " buildozer.spec; then
            echo "✓ buildozer.spec appears valid"
          else
            echo "Error: buildozer.spec missing required fields"
            exit 1
          fi

  build:
    name: Build APK
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Cache Buildozer global directory
        uses: actions/cache@v4
        with:
          path: ~/.buildozer
          key: buildozer-${{ runner.os }}-${{ hashFiles('buildozer.spec') }}
          restore-keys: |
            buildozer-${{ runner.os }}-

      - name: Cache Buildozer local directory
        uses: actions/cache@v4
        with:
          path: .buildozer
          key: buildozer-local-${{ runner.os }}-${{ hashFiles('buildozer.spec') }}
          restore-keys: |
            buildozer-local-${{ runner.os }}-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            git \
            zip \
            unzip \
            openjdk-17-jdk \
            autoconf \
            libtool \
            pkg-config \
            zlib1g-dev \
            libncurses5-dev \
            libncursesw5-dev \
            libtinfo5 \
            cmake \
            libffi-dev \
            libssl-dev \
            automake \
            ccache

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install --upgrade \
            buildozer==${{ env.BUILDOZER_VERSION }} \
            cython==${{ env.CYTHON_VERSION }}

      - name: Verify installations
        run: |
          buildozer --version
          python --version
          cython --version
          java -version

      - name: Build APK with Buildozer
        run: |
          buildozer android debug
        env:
          ANDROID_SDK_ROOT: /opt/android-sdk
          BUILDOZER_WARN_ON_ROOT: 1

      - name: Verify APK was created
        run: |
          if [ ! -f bin/*.apk ]; then
            echo "Error: APK file not found in bin/ directory"
            exit 1
          fi
          ls -lh bin/*.apk
          echo "✓ APK built successfully"

      - name: Get APK info
        id: apk_info
        run: |
          APK_FILE=$(ls bin/*.apk | head -n 1)
          APK_SIZE=$(du -h "$APK_FILE" | cut -f1)
          APK_NAME=$(basename "$APK_FILE")
          echo "apk_file=$APK_FILE" >> $GITHUB_OUTPUT
          echo "apk_size=$APK_SIZE" >> $GITHUB_OUTPUT
          echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: LegendaryCalc-APK-${{ github.sha }}
          path: bin/*.apk
          retention-days: 30
          if-no-files-found: error

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.sha }}
          path: |
            .buildozer/android/platform/build-*/logs/*.log
            .buildozer/android/platform/python-for-android/src/*/build.log
          if-no-files-found: ignore
          retention-days: 7

      - name: Create build summary
        if: success()
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## ✅ Build Successful

          **APK Details:**
          - **Name:** ${{ steps.apk_info.outputs.apk_name }}
          - **Size:** ${{ steps.apk_info.outputs.apk_size }}
          - **Commit:** \`${{ github.sha }}\`
          - **Branch:** \`${{ github.ref_name }}\`

          **Environment:**
          - Python: ${{ env.PYTHON_VERSION }}
          - Buildozer: ${{ env.BUILDOZER_VERSION }}
          - Cython: ${{ env.CYTHON_VERSION }}
          EOF

  release:
    name: Create Release (on tag)
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download APK
        uses: actions/download-artifact@v4
        with:
          name: LegendaryCalc-APK-${{ github.sha }}
          path: apk/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: apk/*.apk
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
